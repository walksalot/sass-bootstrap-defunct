name: Codex Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  codex:
    if: >-
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@codex') &&
       github.event.comment.user.login != 'github-actions[bot]') ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@codex') &&
       github.event.comment.user.login != 'github-actions[bot]') ||
      (github.event_name == 'issues' &&
       contains(github.event.issue.body, '@codex'))
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Codex Assistant
        uses: openai/codex-action@v1
        with:
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          trigger-phrase: "@codex"
          model: gpt-5.3-codex
          effort: xhigh
          github-token: ${{ secrets.GITHUB_TOKEN }}
          use-compact-model: false
          config: |
            model_reasoning_effort = "xhigh"
            [tools]
            web_search = true
            [tools.bash]
            enabled = true
          prompt: |
            You are an autonomous assistant for this repository.

            Process:
            1. Read the request context from the issue/PR comment.
            2. Make the smallest safe code changes that solve the request.
            3. Run relevant checks.
            4. Commit and push only when checks pass.
            5. Summarize exactly what changed.

            Safety:
            - Do not make unrelated refactors.
            - Keep changes scoped to the request.
            - If blocked, explain the blocker and next action.
