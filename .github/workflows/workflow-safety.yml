name: Workflow Safety

on:
  pull_request:
    paths:
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: read

jobs:
  workflow-safety:
    name: Workflow Safety
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Detect changed workflow files
        id: changed
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number,
              per_page: 100
            });

            const changedWorkflows = files
              .filter(file => file.filename.startsWith('.github/workflows/'))
              .filter(file => file.status !== 'removed')
              .map(file => file.filename);

            const removedWorkflows = files
              .filter(file => file.filename.startsWith('.github/workflows/'))
              .filter(file => file.status === 'removed')
              .map(file => file.filename);

            core.info(`Changed workflow files: ${changedWorkflows.join(', ') || '(none)'}`);
            core.info(`Removed workflow files: ${removedWorkflows.join(', ') || '(none)'}`);
            core.setOutput('count', String(changedWorkflows.length));
            core.setOutput('files_json', JSON.stringify(changedWorkflows));

      - name: Validate YAML syntax
        if: steps.changed.outputs.count != '0'
        env:
          FILES_JSON: ${{ steps.changed.outputs.files_json }}
        run: |
          ruby -e 'require "json"; require "yaml"; files = JSON.parse(ENV.fetch("FILES_JSON")); files.each { |f| YAML.load_file(f) }; puts "Validated #{files.length} workflow file(s)."'

      - name: Install actionlint
        if: steps.changed.outputs.count != '0'
        run: |
          set -euo pipefail
          version="1.7.7"
          url="https://github.com/rhysd/actionlint/releases/download/v${version}/actionlint_${version}_linux_amd64.tar.gz"
          for attempt in 1 2 3 4 5; do
            echo "Downloading actionlint (attempt ${attempt})"
            rm -f /tmp/actionlint.tar.gz
            if curl -fsSL --retry 3 --retry-delay 2 --retry-all-errors -o /tmp/actionlint.tar.gz "${url}"; then
              if tar -tzf /tmp/actionlint.tar.gz >/dev/null 2>&1; then
                tar -xzf /tmp/actionlint.tar.gz -C /tmp actionlint
                install -m 0755 /tmp/actionlint /usr/local/bin/actionlint
                actionlint -version
                exit 0
              fi
              echo "Downloaded file was not a valid tar.gz; retrying..."
            fi
            sleep 2
          done
          echo "Failed to install actionlint after multiple attempts." >&2
          exit 1

      - name: Lint changed workflows
        if: steps.changed.outputs.count != '0'
        env:
          FILES_JSON: ${{ steps.changed.outputs.files_json }}
        run: |
          node -e 'const files = JSON.parse(process.env.FILES_JSON); for (const file of files) console.log(file);' > /tmp/changed-workflows.txt
          xargs -a /tmp/changed-workflows.txt actionlint

      - name: Enforce workflow policy
        if: steps.changed.outputs.count != '0'
        env:
          FILES_JSON: ${{ steps.changed.outputs.files_json }}
        run: |
          node .github/scripts/workflow-policy-check.mjs --files-json "$FILES_JSON"
