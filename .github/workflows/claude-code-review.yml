name: Claude PR Auto-Review

on:
  pull_request:
    types: [opened, reopened, synchronize]

concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

jobs:
  review:
    if: >-
      github.event.pull_request.user.login != 'copilot' &&
      github.event.pull_request.user.login != 'dependabot[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Detect Review Workflow Changes
        id: workflow_delta
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number,
              per_page: 100
            });

            const changed = files.some(f => f.filename === '.github/workflows/claude-code-review.yml');
            core.setOutput('review_workflow_changed', changed ? 'true' : 'false');
            core.info(`Review workflow file changed in this PR: ${changed}`);

      - name: Claude Code Review (Primary)
        id: primary_review
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_bots: 'claude,claude[bot],app/claude,github-actions[bot]'
          claude_args: |
            --model claude-opus-4-6
            --max-turns 45
            --allowedTools "Read,Edit,Write,Glob,Grep,LS,Task,mcp__github_inline_comment__create_inline_comment,mcp__github_comment__update_claude_comment"
          prompt: |
            Review pull request #${{ github.event.pull_request.number }} in ${{ github.repository }}.
            At the top of your final review comment, include EXACTLY one verdict line:
            - VERDICT: APPROVED_FOR_MERGE
            - VERDICT: NOT_APPROVED_FOR_MERGE

            If not approved, include:
            1) Why it is not approved (plain English)
            2) REQUIRED_CHANGES as a numbered checklist with concrete file/behavior fixes
            3) Inline code comments for each blocking issue when a file/line is identifiable

            Focus only on high-impact findings (P0-P2): correctness, security, data integrity, user-visible regressions.
            Skip style-only and low-value nits.
          additional_permissions: |
            actions: read
          include_fix_links: 'true'
          track_progress: 'true'

      - name: Claude Code Review (Fallback)
        id: fallback_review
        if: steps.primary_review.outcome == 'failure'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_bots: 'claude,claude[bot],app/claude,github-actions[bot]'
          claude_args: |
            --model claude-opus-4-6
            --max-turns 24
            --allowedTools "Read,Edit,Write,Glob,Grep,LS,Task,mcp__github_inline_comment__create_inline_comment,mcp__github_comment__update_claude_comment"
          prompt: |
            Review pull request #${{ github.event.pull_request.number }} in ${{ github.repository }}.
            At the top of your final review comment, include EXACTLY one verdict line:
            - VERDICT: APPROVED_FOR_MERGE
            - VERDICT: NOT_APPROVED_FOR_MERGE

            Fallback mode: report only blocking issues (P0-P1). Skip optional improvements and nits.
            If not approved, include a REQUIRED_CHANGES numbered checklist with only must-fix items.
          additional_permissions: |
            actions: read
          include_fix_links: 'true'
          track_progress: 'true'

      - name: Finalize Review Status
        if: always()
        run: |
          echo "Primary outcome: ${{ steps.primary_review.outcome }}"
          echo "Fallback outcome: ${{ steps.fallback_review.outcome }}"
          echo "Review workflow changed: ${{ steps.workflow_delta.outputs.review_workflow_changed }}"
          {
            echo "### Review Bot Result"
            echo ""
            echo "- Primary run: \`${{ steps.primary_review.outcome }}\`"
            echo "- Fallback run: \`${{ steps.fallback_review.outcome }}\`"
            echo "- Workflow self-change detected: \`${{ steps.workflow_delta.outputs.review_workflow_changed }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ steps.primary_review.outcome }}" = "success" ] || [ "${{ steps.fallback_review.outcome }}" = "success" ]; then
            echo "Review completed successfully."
            echo "- Final decision: \`APPROVED_FOR_MERGE\`" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          if [ "${{ steps.workflow_delta.outputs.review_workflow_changed }}" = "true" ]; then
            echo "Review skipped: PR modifies .github/workflows/claude-code-review.yml, which prevents Claude app-token validation in PR context."
            echo "- Final decision: \`APPROVED_FOR_MERGE (workflow self-change exception)\`" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "Both review attempts failed."
          echo "- Final decision: \`NOT_APPROVED_FOR_MERGE\`" >> "$GITHUB_STEP_SUMMARY"
          exit 1

      - name: Publish Explicit Review Verdict
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const headSha = context.payload.pull_request.head.sha;
            const primaryOutcome = '${{ steps.primary_review.outcome }}';
            const fallbackOutcome = '${{ steps.fallback_review.outcome }}';
            const workflowChanged = '${{ steps.workflow_delta.outputs.review_workflow_changed }}' === 'true';

            let verdict = 'NOT_APPROVED_FOR_MERGE';
            let why = [];
            let next = [];

            if (primaryOutcome === 'success' || fallbackOutcome === 'success') {
              verdict = 'APPROVED_FOR_MERGE';
              why = [
                'Claude review completed without blocking findings.'
              ];
              next = [
                'No blocking review changes are required before merge.'
              ];
            } else if (workflowChanged) {
              verdict = 'APPROVED_FOR_MERGE';
              why = [
                'This PR modifies the review workflow file, so review is skipped in this context to avoid self-review token restrictions.'
              ];
              next = [
                'Workflow Safety remains required for workflow-file changes.'
              ];
            } else {
              verdict = 'NOT_APPROVED_FOR_MERGE';
              why = [
                'Claude review did not pass this commit.'
              ];
              next = [
                'Address all blocking Claude review findings and REQUIRED_CHANGES checklist items.',
                'Push the fixes to this PR branch.',
                'A new automatic review will run and re-evaluate merge approval.'
              ];
            }

            const marker = `<!-- review-verdict:${headSha} -->`;
            const body = [
              marker,
              '## Review Verdict',
              '',
              `VERDICT: ${verdict}`,
              '',
              'Why:',
              ...why.map(item => `- ${item}`),
              '',
              'What to do next:',
              ...next.map(item => `- ${item}`)
            ].join('\n');

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100
            });
            const existing = comments.find(comment => comment.body?.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              });
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body
            });
